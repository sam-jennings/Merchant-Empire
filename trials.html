<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archmage Ascension - The Ascension Trial</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load the configuration file -->
    <script src="config.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const config = GameConfig; // Load configuration

        // Icons (unchanged)
        const Calculator = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
        );
        const Plus = ({ className = "w-4 h-4" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
        );
        const Trash = ({ className = "w-5 h-5" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );
        const Users = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
        );
        const Lock = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
        );
        const Unlock = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
            </svg>
        );
        const Trophy = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
            </svg>
        );
        const Crown = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3l7 7 7-7M5 21l7-7 7 7M12 3v18" />
            </svg>
        );
        const Zap = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
        );
        const Sparkles = ({ className = "w-6 h-6" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
            </svg>
        );
        const AlertTriangle = ({ className = "w-5 h-5" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        );

        // Icon mapping
        const IconMap = { Users, Trophy, Crown, Zap, Sparkles };

        // Build lookup objects from config
        const ELEMENT_SYMBOLS = Object.fromEntries(
          config.elements.map(e => [e.name, e.symbol])
        );
        
        const DOMAIN_NAMES = Object.fromEntries(
          Object.entries(config.domains).map(([key, val]) => [key, val.name])
        );

        // Spell Calculator Component
        function SpellCalculator({ wizardId, onDomainsCalculated }) {
          const [spells, setSpells] = useState([]);
          const [showCalculator, setShowCalculator] = useState(true);

          const addSpell = (type) => {
            setSpells([...spells, { id: Date.now(), type: type, element: config.elements[0].name, size: 3 }]);
          };

          const updateSpell = (id, field, value) => {
            setSpells(spells.map(s => s.id === id ? { ...s, [field]: value } : s));
          };

          const removeSpell = (id) => {
            setSpells(spells.filter(s => s.id !== id));
          };

          const getSpellWarning = (spell) => {
            const spellType = config.spellTypes.find(st => st.id === spell.type);
            if (!spellType) return null;
            
            if (spell.size < spellType.warnUnder) {
              return `⚠️ ${spellType.name}s need at least ${spellType.warnUnder} components`;
            }
            if (spell.size > spellType.warnOver) {
              return `⚠️ ${spellType.name}s typically don't exceed ${spellType.warnOver} components`;
            }
            return null;
          };

          const calculatedDomains = useMemo(() => {
            const domains = {};
            Object.keys(config.domains).forEach(key => domains[key] = 0);
            
            spells.forEach(spell => {
              const spellType = config.spellTypes.find(st => st.id === spell.type);
              if (spellType && spellType.contributeToDomains) {
                spellType.contributeToDomains(spell, domains, config.calculatePower);
              }
            });
            
            return domains;
          }, [spells]);

          useEffect(() => {
            onDomainsCalculated(calculatedDomains);
          }, [calculatedDomains]);

          const getSpellTypeLabel = (type) => {
            const spellType = config.spellTypes.find(st => st.id === type);
            return spellType ? `${spellType.emoji} ${spellType.name}` : type;
          };

          const getSpellContribution = (spell) => {
            const spellType = config.spellTypes.find(st => st.id === spell.type);
            if (!spellType) return '';
            
            const power = config.calculatePower(spell.size);
            const tempDomains = {};
            Object.keys(config.domains).forEach(key => tempDomains[key] = 0);
            spellType.contributeToDomains(spell, tempDomains, config.calculatePower);
            
            const contributions = [];
            Object.entries(tempDomains).forEach(([key, value]) => {
              if (value > 0) {
                contributions.push(`${DOMAIN_NAMES[key]}: +${value} ${key === 'wilds' ? 'wild' : 'power'}`);
              }
            });
            
            return contributions.join(', ');
          };

          return (
            <div className="space-y-4">
              <button onClick={() => setShowCalculator(!showCalculator)} className={`flex items-center gap-2 px-4 py-2 bg-${config.colors.primary}-600 text-white rounded hover:bg-${config.colors.primary}-700 transition`}>
                <Calculator className="w-5 h-5" />
                {showCalculator ? 'Hide' : 'Show'} {config.text.calculatorButton}
              </button>

              {showCalculator && (
                <div className={`bg-${config.colors.primary}-50 rounded-lg p-6 border-2 border-${config.colors.primary}-300 space-y-4`}>
                  <div>
                    <h4 className={`text-lg font-bold text-${config.colors.primary}-900 mb-2`}>Enter Your Spells</h4>
                    <p className={`text-sm text-${config.colors.primary}-700 mb-3`}>Formula: {config.powerFormulaDescription}</p>
                  </div>
                  
                  <div className="flex flex-wrap gap-2 mb-4">
                    {config.spellTypes.map(spellType => (
                      <button 
                        key={spellType.id}
                        onClick={() => addSpell(spellType.id)} 
                        className={`px-3 py-2 bg-${config.colors.secondary}-600 text-white text-sm rounded hover:bg-${config.colors.secondary}-700 transition flex items-center gap-2`}
                      >
                        <Plus /> {spellType.name}
                      </button>
                    ))}
                  </div>

                  {spells.length === 0 ? (
                    <div className="text-gray-500 italic text-center py-6 bg-white rounded border border-gray-200">
                      No spells added yet. Click the buttons above.
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {spells.map(spell => {
                        const warning = getSpellWarning(spell);
                        const spellType = config.spellTypes.find(st => st.id === spell.type);
                        return (
                          <div key={spell.id} className={`bg-white rounded p-4 border-2 space-y-3 ${warning ? 'border-yellow-400' : 'border-gray-200'}`}>
                            <div className="flex justify-between items-start">
                              <div>
                                <div className="font-semibold text-gray-900 text-lg">{getSpellTypeLabel(spell.type)}</div>
                                <div className={`text-xs text-${config.colors.primary}-600 font-medium mt-1`}>
                                  {config.getPowerBreakdown(spell.size, config.calculatePower)}
                                </div>
                              </div>
                              <button onClick={() => removeSpell(spell.id)} className="text-red-600 hover:text-red-800 transition">
                                <Trash />
                              </button>
                            </div>
                            
                            {warning && (
                              <div className="flex items-center gap-2 text-xs text-yellow-700 bg-yellow-50 p-2 rounded border border-yellow-300">
                                <AlertTriangle className="w-4 h-4" />
                                <span>{warning}</span>
                              </div>
                            )}
                            
                            <div className="grid grid-cols-2 gap-3">
                              {spellType?.requiresElement && (
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-1">Element:</label>
                                  <select value={spell.element} onChange={(e) => updateSpell(spell.id, 'element', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded">
                                    {config.elements.map(element => (
                                      <option key={element.id} value={element.name}>
                                        {element.symbol} {element.name}
                                      </option>
                                    ))}
                                  </select>
                                </div>
                              )}
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Size:</label>
                                <input 
                                  type="number" 
                                  value={spell.size} 
                                  onChange={(e) => updateSpell(spell.id, 'size', parseInt(e.target.value) || 0)} 
                                  className="w-full px-3 py-2 border border-gray-300 rounded" 
                                />
                              </div>
                            </div>
                            <div className="text-xs text-gray-600 pt-2 border-t border-gray-200 bg-gray-50 p-2 rounded">
                              <strong>Contributes:</strong> <span className="ml-2">{getSpellContribution(spell)}</span>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}

                  <div className={`mt-6 bg-gradient-to-br from-white to-${config.colors.primary}-50 rounded-lg p-5 border-2 border-${config.colors.primary}-400 shadow-md`}>
                    <h5 className={`font-bold text-${config.colors.primary}-900 mb-4 text-center text-lg border-b border-${config.colors.primary}-300 pb-2`}>
                      Calculated Total Power
                    </h5>
                    <div className="grid grid-cols-2 gap-3">
                      {Object.entries(calculatedDomains).map(([key, value]) => (
                        <div key={key} className={`flex justify-between p-2 rounded border ${key === 'wilds' ? 'bg-amber-100 border-amber-400 col-span-2 border-2' : `bg-${config.colors.primary}-50 border-${config.colors.primary}-200`}`}>
                          <span className={`font-medium ${key === 'wilds' ? 'text-amber-900 font-bold' : 'text-gray-700'}`}>
                            {DOMAIN_NAMES[key]}:
                          </span>
                          <span className={`font-bold text-lg ${key === 'wilds' ? 'text-amber-900 text-xl' : `text-${config.colors.primary}-900`}`}>
                            {value}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        // Main App Component
        function ArchmageAscensionApp() {
          const [gameState, setGameState] = useState('setup');
          const [wizards, setWizards] = useState([]);
          const [newWizardName, setNewWizardName] = useState('');
          const [currentWizardId, setCurrentWizardId] = useState(null);

          const addWizard = () => {
            if (newWizardName.trim()) {
              const newWizard = {
                id: Date.now(),
                name: newWizardName.trim(),
                domains: Object.fromEntries(Object.keys(config.domains).map(k => [k, 0])),
                allocations: {},
                locked: false
              };
              setWizards([newWizard, ...wizards]);
              setNewWizardName('');
            }
          };

          const removeWizard = (wizardId) => {
            setWizards(wizards.filter(w => w.id !== wizardId));
            if (currentWizardId === wizardId) setCurrentWizardId(null);
          };

          const updateWizardDomains = (wizardId, domains) => {
            setWizards(wizards.map(w => w.id === wizardId ? { ...w, domains } : w));
          };

          const startVoting = () => {
            if (wizards.length >= 2 && wizards.every(w => 
              Object.values(w.domains).some(v => v > 0)
            )) {
              setGameState('voting');
              setCurrentWizardId(wizards[0].id);
            }
          };

          const allWizardsLocked = useMemo(() => 
            wizards.length > 0 && wizards.every(w => w.locked),
            [wizards]
          );

          const showResults = () => {
            if (allWizardsLocked) {
              setGameState('results');
            }
          };

          return (
            <div className={`min-h-screen bg-gradient-to-br ${config.colors.background} p-8`}>
              <div className="max-w-7xl mx-auto">
                <header className="text-center mb-8">
                  <h1 className={`text-5xl font-bold text-${config.colors.primary}-900 mb-2`}>
                    {config.gameName}
                  </h1>
                  <h2 className={`text-2xl text-${config.colors.primary}-700`}>
                    {config.gameSubtitle}
                  </h2>
                </header>

                {gameState === 'setup' && (
                  <SetupPhase 
                    wizards={wizards}
                    newWizardName={newWizardName}
                    setNewWizardName={setNewWizardName}
                    addWizard={addWizard}
                    removeWizard={removeWizard}
                    updateWizardDomains={updateWizardDomains}
                    startVoting={startVoting}
                  />
                )}

                {gameState === 'voting' && (
                  <VotingPhase 
                    wizards={wizards}
                    setWizards={setWizards}
                    currentWizardId={currentWizardId}
                    setCurrentWizardId={setCurrentWizardId}
                    allWizardsLocked={allWizardsLocked}
                    showResults={showResults}
                  />
                )}

                {gameState === 'results' && (
                  <ResultsPhase wizards={wizards} />
                )}
              </div>
            </div>
          );
        }

        // Setup Phase Component
        function SetupPhase({ wizards, newWizardName, setNewWizardName, addWizard, removeWizard, updateWizardDomains, startVoting }) {
          const canStart = wizards.length >= 2 && wizards.every(w => 
            Object.values(w.domains).some(v => v > 0)
          );

          return (
            <div className="bg-white rounded-lg shadow-xl p-8">
              <h3 className={`text-2xl font-bold text-${config.colors.primary}-900 mb-6`}>
                {config.text.setupHeader}
              </h3>
              
              <div className="mb-8">
                <h4 className={`text-lg font-semibold text-${config.colors.primary}-800 mb-4`}>
                  {config.text.addPlayersHeader}
                </h4>
                <div className="flex gap-4 mb-4">
                  <input
                    type="text"
                    value={newWizardName}
                    onChange={(e) => setNewWizardName(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && addWizard()}
                    placeholder={config.text.playerInputPlaceholder}
                    className={`flex-1 px-4 py-2 border-2 border-${config.colors.primary}-300 rounded-lg focus:outline-none focus:border-${config.colors.primary}-500`}
                  />
                  <button
                    onClick={addWizard}
                    className={`px-6 py-2 bg-${config.colors.primary}-600 text-white rounded-lg hover:bg-${config.colors.primary}-700 transition-colors`}
                  >
                    {config.text.addPlayerButton}
                  </button>
                </div>
              </div>

              {wizards.length > 0 && (
                <div className="space-y-6">
                  <h4 className={`text-lg font-semibold text-${config.colors.primary}-800`}>
                    {config.text.setupSubheader}
                  </h4>
                  {wizards.map(wizard => (
                    <WizardDomainSetup
                      key={wizard.id}
                      wizard={wizard}
                      updateWizardDomains={updateWizardDomains}
                      removeWizard={removeWizard}
                    />
                  ))}
                </div>
              )}

              {wizards.length >= 2 && (
                <button
                  onClick={startVoting}
                  disabled={!canStart}
                  className={`mt-8 w-full py-4 rounded-lg text-white text-xl font-bold transition-colors ${
                    canStart 
                      ? `bg-${config.colors.success}-600 hover:bg-${config.colors.success}-700 cursor-pointer` 
                      : 'bg-gray-400 cursor-not-allowed'
                  }`}
                >
                  {canStart ? config.text.startGameButton : config.text.startGameRequirement}
                </button>
              )}
            </div>
          );
        }

        // Wizard Domain Setup Component
        function WizardDomainSetup({ wizard, updateWizardDomains, removeWizard }) {
          const [useManualOverride, setUseManualOverride] = useState(false);
          const [manualDomains, setManualDomains] = useState(wizard.domains);

          const handleDomainsCalculated = (calculatedDomains) => {
            if (!useManualOverride) {
              updateWizardDomains(wizard.id, calculatedDomains);
            }
          };

          const handleManualDomainChange = (domain, value) => {
            const newDomains = { ...manualDomains, [domain]: parseInt(value) || 0 };
            setManualDomains(newDomains);
            if (useManualOverride) {
              updateWizardDomains(wizard.id, newDomains);
            }
          };

          const toggleManualOverride = () => {
            const newUseManual = !useManualOverride;
            setUseManualOverride(newUseManual);
            if (newUseManual) {
              updateWizardDomains(wizard.id, manualDomains);
            }
          };

          const totalPower = Object.values(wizard.domains).reduce((sum, v) => sum + v, 0);

          return (
            <div className={`bg-${config.colors.primary}-50 rounded-lg p-6 border-2 border-${config.colors.primary}-200`}>
              <div className="flex justify-between items-center mb-4">
                <h5 className={`text-xl font-bold text-${config.colors.primary}-900`}>{wizard.name}</h5>
                <div className="flex items-center gap-4">
                  <span className={`text-sm font-semibold text-${config.colors.primary}-700`}>
                    Total Power: {totalPower}
                  </span>
                  <button
                    onClick={() => removeWizard(wizard.id)}
                    className={`px-3 py-1 bg-${config.colors.danger}-500 text-white text-sm rounded hover:bg-${config.colors.danger}-600`}
                  >
                    {config.text.removeButton}
                  </button>
                </div>
              </div>

              {!useManualOverride && (
                <SpellCalculator
                  wizardId={wizard.id}
                  onDomainsCalculated={handleDomainsCalculated}
                />
              )}

              <div className="mt-6">
                <button
                  onClick={toggleManualOverride}
                  className={`w-full px-4 py-2 rounded transition ${
                    useManualOverride 
                      ? `bg-${config.colors.secondary}-600 text-white hover:bg-${config.colors.secondary}-700` 
                      : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                  }`}
                >
                  {useManualOverride ? config.text.manualEntryActive : config.text.switchToManual}
                </button>
              </div>

              {useManualOverride && (
                <div className={`mt-4 bg-${config.colors.secondary}-50 rounded-lg p-4 border-2 border-${config.colors.secondary}-300`}>
                  <h5 className={`font-semibold text-${config.colors.secondary}-900 mb-3`}>
                    Manual Power Entry:
                  </h5>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                    {Object.entries(DOMAIN_NAMES).map(([domainKey, domainName]) => (
                      <div key={domainKey}>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                          {domainName}
                        </label>
                        <input
                          type="number"
                          min="0"
                          value={manualDomains[domainKey]}
                          onChange={(e) => handleManualDomainChange(domainKey, e.target.value)}
                          className={`w-full px-3 py-2 border-2 border-${config.colors.secondary}-300 rounded focus:outline-none focus:border-${config.colors.secondary}-500`}
                        />
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <div className="mt-4 bg-white rounded-lg p-4 border border-gray-300">
                <h5 className="font-semibold text-gray-700 mb-3 text-sm">Current Power for Trial Phase:</h5>
                <div className="grid grid-cols-2 gap-2 text-xs">
                  {Object.entries(wizard.domains).map(([key, value]) => (
                    <div key={key} className="flex justify-between p-1 bg-gray-50 rounded">
                      <span className="text-gray-600">{DOMAIN_NAMES[key]}:</span>
                      <span className="font-bold text-gray-900">{value}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          );
        }

        // Voting Phase Component (continues in next part due to length...)
        function VotingPhase({ wizards, setWizards, currentWizardId, setCurrentWizardId, allWizardsLocked, showResults }) {
          const currentWizard = wizards.find(w => w.id === currentWizardId);

          const switchWizard = (wizardId) => {
            setCurrentWizardId(wizardId);
          };

          return (
            <div className="space-y-6">
              <div className="bg-white rounded-lg shadow-xl p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className={`text-2xl font-bold text-${config.colors.primary}-900`}>
                    {config.text.votingHeader}
                  </h3>
                  {allWizardsLocked && (
                    <button
                      onClick={showResults}
                      className={`px-6 py-3 bg-${config.colors.success}-600 text-white rounded-lg hover:bg-${config.colors.success}-700 font-bold transition-colors flex items-center gap-2`}
                    >
                      <Trophy className="w-5 h-5" />
                      {config.text.viewResultsButton}
                    </button>
                  )}
                </div>

                <div className="flex gap-2 mb-6 flex-wrap">
                  {wizards.map(wizard => (
                    <button
                      key={wizard.id}
                      onClick={() => switchWizard(wizard.id)}
                      className={`px-4 py-2 rounded-lg font-semibold transition-colors flex items-center gap-2 ${
                        wizard.id === currentWizardId
                          ? `bg-${config.colors.primary}-600 text-white`
                          : wizard.locked
                          ? `bg-${config.colors.success}-100 text-${config.colors.success}-800 border-2 border-${config.colors.success}-400`
                          : `bg-${config.colors.primary}-100 text-${config.colors.primary}-800 hover:bg-${config.colors.primary}-200`
                      }`}
                    >
                      {wizard.name}
                      {wizard.locked && <Lock className="w-4 h-4" />}
                      {!wizard.locked && <Unlock className="w-4 h-4" />}
                    </button>
                  ))}
                </div>
              </div>

              <div className="bg-white rounded-lg shadow-xl p-6 overflow-x-auto">
                <h3 className={`text-xl font-bold text-${config.colors.primary}-900 mb-4`}>
                  {config.text.referenceTableHeader}
                </h3>
                <table className="w-full border-collapse">
                  <thead>
                    <tr className={`bg-${config.colors.primary}-100 border-b-2 border-${config.colors.primary}-300`}>
                      <th className={`px-4 py-3 text-left font-bold text-${config.colors.primary}-900`}>
                        {config.text.playerNoun}
                      </th>
                      {Object.entries(DOMAIN_NAMES).map(([domainKey, domainName]) => (
                        <th key={domainKey} className={`px-4 py-3 text-center font-bold text-${config.colors.primary}-900`}>
                          {domainName}
                        </th>
                      ))}
                      <th className={`px-4 py-3 text-center font-bold text-${config.colors.primary}-900`}>Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {wizards.map((wizard) => (
                      <tr 
                        key={wizard.id}
                        className={`border-b border-${config.colors.primary}-200 ${
                          wizard.id === currentWizardId ? `bg-${config.colors.primary}-50` : ''
                        }`}
                      >
                        <td className={`px-4 py-3 font-semibold text-${config.colors.primary}-900`}>
                          {wizard.name}
                          {wizard.locked && <Lock className={`inline w-3 h-3 ml-2 text-${config.colors.success}-600`} />}
                        </td>
                        {Object.keys(DOMAIN_NAMES).map(domainKey => (
                          <td key={domainKey} className={`px-4 py-3 text-center text-${config.colors.primary}-900`}>
                            {wizard.domains[domainKey]}
                          </td>
                        ))}
                        <td className={`px-4 py-3 text-center font-bold text-${config.colors.primary}-900`}>
                          {Object.values(wizard.domains).reduce((sum, v) => sum + v, 0)}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {currentWizard && (
                <WizardAllocation
                  wizard={currentWizard}
                  wizards={wizards}
                  setWizards={setWizards}
                />
              )}
            </div>
          );
        }

        // Wizard Allocation Component
        function WizardAllocation({ wizard, wizards, setWizards }) {
          const [selectedTrial, setSelectedTrial] = useState(null);
          
          const wizardCount = wizards.length;
          const rp = config.recognitionPoints[Math.min(wizardCount, 4)] || config.recognitionPoints[4];

          const updateAllocations = (newAllocations) => {
            setWizards(wizards.map(w => 
              w.id === wizard.id ? { ...w, allocations: newAllocations } : w
            ));
          };

          const toggleLock = () => {
            setWizards(wizards.map(w => 
              w.id === wizard.id ? { ...w, locked: !w.locked } : w
            ));
          };

          const totalAllocated = useMemo(() => {
            const allocated = {};
            Object.entries(wizard.allocations).forEach(([trialId, allocation]) => {
              Object.entries(allocation.sources).forEach(([domain, amount]) => {
                allocated[domain] = (allocated[domain] || 0) + amount;
              });
            });
            return allocated;
          }, [wizard.allocations]);

          const remainingPower = useMemo(() => {
            const remaining = { ...wizard.domains };
            Object.keys(remaining).forEach(domain => {
              remaining[domain] -= (totalAllocated[domain] || 0);
            });
            return remaining;
          }, [wizard.domains, totalAllocated]);

          const allPowerAllocated = Object.values(remainingPower).every(v => v === 0);

          return (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2 space-y-4">
                <div className="bg-white rounded-lg shadow-xl p-6">
                  <h4 className={`text-xl font-bold text-${config.colors.primary}-900 mb-4`}>
                    {config.text.remainingPowerHeader}
                  </h4>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    {Object.entries(DOMAIN_NAMES).map(([domainKey, domainName]) => (
                      <div key={domainKey} className={`bg-${config.colors.primary}-50 p-3 rounded border-2 border-${config.colors.primary}-200`}>
                        <div className={`text-sm text-${config.colors.primary}-700 mb-1`}>{domainName}</div>
                        <div className={`text-2xl font-bold text-${config.colors.primary}-900`}>
                          <span className={remainingPower[domainKey] === 0 ? 'text-gray-400' : ''}>
                            {remainingPower[domainKey]}
                          </span>
                          <span className="text-sm text-gray-500"> / {wizard.domains[domainKey]}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-white rounded-lg shadow-xl p-6">
                  <h4 className={`text-xl font-bold text-${config.colors.primary}-900 mb-4`}>
                    {config.text.selectTrialHeader}
                  </h4>
                  <div className="space-y-3">
                    {config.trials.map(trial => {
                      const Icon = IconMap[trial.icon] || Users;
                      const currentAllocation = wizard.allocations[trial.id];
                      const total = currentAllocation 
                        ? Object.values(currentAllocation.sources).reduce((sum, v) => sum + v, 0)
                        : 0;

                      return (
                        <button
                          key={trial.id}
                          onClick={() => setSelectedTrial(trial.id)}
                          disabled={wizard.locked}
                          className={`w-full p-4 rounded-lg border-2 transition-colors text-left ${
                            selectedTrial === trial.id
                              ? `border-${config.colors.primary}-600 bg-${config.colors.primary}-50`
                              : total > 0 && !wizard.locked
                              ? `border-${config.colors.success}-400 bg-${config.colors.success}-50 hover:bg-${config.colors.success}-100`
                              : `border-${config.colors.primary}-200 hover:bg-${config.colors.primary}-50`
                          } ${wizard.locked ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}
                        >
                          <div className="flex items-start justify-between">
                            <div className="flex items-start gap-3 flex-1">
                              <Icon className={`w-6 h-6 text-${config.colors.primary}-700 mt-1 flex-shrink-0`} />
                              <div className="flex-1">
                                <div className="flex items-center gap-2 flex-wrap">
                                  <span className={`font-bold text-${config.colors.primary}-900`}>{trial.name}</span>
                                  <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-bold">
                                    {rp[trial.id]} {config.pointsAbbreviation}
                                  </span>
                                </div>
                                <div className={`text-sm text-${config.colors.primary}-700 mt-1`}>{trial.description}</div>
                              </div>
                            </div>
                            {total > 0 && !wizard.locked && (
                              <div className={`ml-4 px-3 py-1 bg-${config.colors.success}-600 text-white rounded-full font-bold`}>
                                {total}
                              </div>
                            )}
                          </div>
                        </button>
                      );
                    })}
                  </div>
                </div>
              </div>

              <div className="space-y-4">
                {selectedTrial && !wizard.locked && (
                  <TrialAllocation
                    wizard={wizard}
                    trialId={selectedTrial}
                    trial={config.trials.find(t => t.id === selectedTrial)}
                    remainingPower={remainingPower}
                    updateAllocations={updateAllocations}
                  />
                )}

                <div className="bg-white rounded-lg shadow-xl p-6 sticky top-4">
                  <h4 className={`text-lg font-bold text-${config.colors.primary}-900 mb-4`}>Lock Status</h4>
                  
                  {!allPowerAllocated && !wizard.locked && (
                    <div className={`mb-4 p-3 bg-${config.colors.warning}-50 border-2 border-${config.colors.warning}-300 rounded text-sm text-${config.colors.warning}-800`}>
                      {config.text.unallocatedWarning}
                    </div>
                  )}

                  <button
                    onClick={toggleLock}
                    className={`w-full py-3 rounded-lg font-bold text-white transition-colors flex items-center justify-center gap-2 ${
                      wizard.locked
                        ? `bg-${config.colors.danger}-600 hover:bg-${config.colors.danger}-700`
                        : `bg-${config.colors.success}-600 hover:bg-${config.colors.success}-700`
                    }`}
                  >
                    {wizard.locked ? (
                      <>
                        <Unlock className="w-5 h-5" />
                        {config.text.unlockButton}
                      </>
                    ) : (
                      <>
                        <Lock className="w-5 h-5" />
                        {config.text.lockButton}
                      </>
                    )}
                  </button>

                  {wizard.locked && (
                    <p className="mt-3 text-sm text-center text-gray-600">
                      {config.text.lockedMessage}
                    </p>
                  )}
                </div>
              </div>
            </div>
          );
        }

        // Trial Allocation Component
        function TrialAllocation({ wizard, trialId, trial, remainingPower, updateAllocations }) {
          const currentAllocation = wizard.allocations[trialId] || { sources: {} };
          
          const currentSources = Object.keys(currentAllocation.sources).filter(d => d !== 'wilds');
          const availableDomains = trial.getAvailableDomains(currentSources);
          
          const hasRegularPower = Object.keys(currentAllocation.sources).some(d => d !== 'wilds' && currentAllocation.sources[d] > 0);

          const updateDomainAllocation = (domain, value) => {
            const numValue = Math.max(0, parseInt(value) || 0);
            const maxAllowed = remainingPower[domain] + (currentAllocation.sources[domain] || 0);
            const finalValue = Math.min(numValue, maxAllowed);

            const newSources = { ...currentAllocation.sources };
            if (finalValue === 0) {
              delete newSources[domain];
            } else {
              newSources[domain] = finalValue;
            }

            const regularSources = Object.keys(newSources).filter(d => d !== 'wilds');

            // Validate against maxSources
            if (trial.maxSources && regularSources.length > trial.maxSources) {
              return;
            }

            const newAllocations = { ...wizard.allocations };
            if (Object.keys(newSources).length === 0) {
              delete newAllocations[trialId];
            } else {
              newAllocations[trialId] = { sources: newSources };
            }

            updateAllocations(newAllocations);
          };

          const clearAllocation = () => {
            const newAllocations = { ...wizard.allocations };
            delete newAllocations[trialId];
            updateAllocations(newAllocations);
          };

          const total = Object.values(currentAllocation.sources).reduce((sum, v) => sum + v, 0);

          return (
            <div className="bg-white rounded-lg shadow-xl p-6">
              <div className="flex items-start justify-between mb-4">
                <h4 className={`text-lg font-bold text-${config.colors.primary}-900`}>{trial.name}</h4>
                {total > 0 && (
                  <button
                    onClick={clearAllocation}
                    className={`px-3 py-1 bg-${config.colors.danger}-500 text-white text-sm rounded hover:bg-${config.colors.danger}-600`}
                  >
                    {config.text.clearButton}
                  </button>
                )}
              </div>
              
              <p className={`text-sm text-${config.colors.primary}-700 mb-4`}>{trial.description}</p>

              <div className="space-y-3">
                {Object.entries(DOMAIN_NAMES).map(([domainKey, domainName]) => {
                  if (domainKey === 'wilds') {
                    return (
                      <div key={domainKey} className={`pt-3 border-t-2 border-amber-200 ${!hasRegularPower ? 'opacity-40' : ''}`}>
                        <label className="block text-sm font-medium text-amber-800 mb-1">
                          {domainName} ⭐
                        </label>
                        {!hasRegularPower && (
                          <p className="text-xs text-amber-700 mb-2 italic">
                            {config.text.wildMagicNote}
                          </p>
                        )}
                        <input
                          type="number"
                          min="0"
                          max={remainingPower.wilds + (currentAllocation.sources.wilds || 0)}
                          value={currentAllocation.sources.wilds || 0}
                          onChange={(e) => updateDomainAllocation('wilds', e.target.value)}
                          disabled={!hasRegularPower}
                          className={`w-full px-3 py-2 border-2 rounded focus:outline-none ${
                            hasRegularPower
                              ? 'border-amber-300 focus:border-amber-500'
                              : 'border-gray-300 bg-gray-100 cursor-not-allowed'
                          }`}
                        />
                        <div className="text-xs text-gray-600 mt-1">
                          {config.text.availablePower}: {remainingPower.wilds + (currentAllocation.sources.wilds || 0)}
                        </div>
                      </div>
                    );
                  }
                  
                  const isAvailable = availableDomains.includes(domainKey);
                  const currentValue = currentAllocation.sources[domainKey] || 0;
                  const maxValue = remainingPower[domainKey] + currentValue;

                  return (
                    <div key={domainKey} className={isAvailable ? '' : 'opacity-40'}>
                      <label className={`block text-sm font-medium text-${config.colors.primary}-800 mb-1`}>
                        {domainName}
                      </label>
                      <input
                        type="number"
                        min="0"
                        max={maxValue}
                        value={currentValue}
                        onChange={(e) => updateDomainAllocation(domainKey, e.target.value)}
                        disabled={!isAvailable}
                        className={`w-full px-3 py-2 border-2 rounded focus:outline-none ${
                          isAvailable
                            ? `border-${config.colors.primary}-300 focus:border-${config.colors.primary}-500`
                            : 'border-gray-300 bg-gray-100 cursor-not-allowed'
                        }`}
                      />
                      <div className="text-xs text-gray-600 mt-1">
                        {config.text.availablePower}: {maxValue}
                      </div>
                    </div>
                  );
                })}
              </div>

              {total > 0 && (
                <div className={`mt-4 pt-4 border-t-2 border-${config.colors.primary}-200`}>
                  <div className={`text-lg font-bold text-${config.colors.primary}-900`}>
                    {config.text.totalPower}: {total}
                  </div>
                </div>
              )}
            </div>
          );
        }

        // Results Phase Component
        function ResultsPhase({ wizards }) {
          const wizardCount = wizards.length;
          const rp = config.recognitionPoints[Math.min(wizardCount, 4)] || config.recognitionPoints[4];

          const calculateResults = () => {
            const results = {};

            config.trials.forEach(trial => {
              const contestants = wizards.map(wizard => {
                const allocation = wizard.allocations[trial.id];
                if (!allocation) return null;

                const total = Object.values(allocation.sources).reduce((sum, v) => sum + v, 0);
                if (total === 0) return null;

                const domainsUsed = Object.keys(allocation.sources).filter(d => d !== 'wilds');
                const elementalDomains = config.elements.map(e => e.id);
                const elementalDomainsUsed = domainsUsed.filter(d => elementalDomains.includes(d));
                const wildPower = allocation.sources.wilds || 0;

                const isValid = trial.isValidAllocation(domainsUsed, elementalDomainsUsed);
                if (!isValid) return null;

                const totalRegularPower = domainsUsed.reduce((sum, domain) => sum + (allocation.sources[domain] || 0), 0);
                const totalCapacity = domainsUsed.reduce((sum, domain) => sum + wizard.domains[domain], 0);
                const utilization = totalCapacity > 0 ? totalRegularPower / totalCapacity : 0;

                const totalWizardPower = Object.entries(wizard.domains)
                  .filter(([domain]) => domain !== 'wilds')
                  .reduce((sum, [, v]) => sum + v, 0);
                const focus = totalWizardPower > 0 ? totalRegularPower / totalWizardPower : 0;

                return {
                  wizardId: wizard.id,
                  wizardName: wizard.name,
                  total,
                  utilization,
                  focus,
                  breadth: domainsUsed.length,
                  domainsUsed,
                  sources: allocation.sources,
                  wildPower
                };
              }).filter(c => c !== null);

              if (contestants.length === 0) {
                results[trial.id] = { winners: [], contestants: [], rpPerWinner: 0 };
                return;
              }

              contestants.sort((a, b) => {
                if (a.total !== b.total) return b.total - a.total;
                if (Math.abs(a.utilization - b.utilization) > 0.0001) return b.utilization - a.utilization;
                if (Math.abs(a.focus - b.focus) > 0.0001) return b.focus - a.focus;
                
                if (trial.usesBreadthTiebreaker) {
                  if (a.breadth !== b.breadth) return b.breadth - a.breadth;
                }
                
                return 0;
              });

              const topTotal = contestants[0].total;
              const topUtil = contestants[0].utilization;
              const topFocus = contestants[0].focus;
              const topBreadth = contestants[0].breadth;

              const winners = contestants.filter(c => 
                c.total === topTotal &&
                Math.abs(c.utilization - topUtil) < 0.0001 &&
                Math.abs(c.focus - topFocus) < 0.0001 &&
                (!trial.usesBreadthTiebreaker || c.breadth === topBreadth)
              );

              results[trial.id] = {
                winners,
                contestants,
                rpPerWinner: rp[trial.id] / winners.length
              };
            });

            return results;
          };

          const results = calculateResults();

          const finalScores = wizards.map(wizard => {
            let totalRP = 0;
            Object.values(results).forEach(result => {
              if (result.winners && result.winners.some(w => w.wizardId === wizard.id)) {
                totalRP += result.rpPerWinner;
              }
            });
            return { wizardId: wizard.id, wizardName: wizard.name, totalRP };
          });

          finalScores.sort((a, b) => b.totalRP - a.totalRP);

          return (
            <div className="space-y-6">
              <div className="bg-white rounded-lg shadow-xl p-8">
                <h3 className={`text-3xl font-bold text-${config.colors.primary}-900 mb-6 text-center`}>
                  {config.text.resultsHeader}
                </h3>

                <div className={`mb-8 p-6 bg-gradient-to-r ${config.colors.cardAccent} rounded-lg border-2 border-${config.colors.primary}-400`}>
                  <h4 className={`text-2xl font-bold text-${config.colors.primary}-900 mb-4`}>
                    {config.text.finalStandingsHeader}
                  </h4>
                  <div className="space-y-2">
                    {finalScores.map((score, index) => (
                      <div key={score.wizardId} className="flex items-center justify-between p-3 bg-white rounded">
                        <div className="flex items-center gap-3">
                          <span className={`text-2xl font-bold text-${config.colors.primary}-700`}>#{index + 1}</span>
                          <span className={`text-xl font-bold text-${config.colors.primary}-900`}>{score.wizardName}</span>
                          {index === 0 && <span className="text-2xl">👑</span>}
                        </div>
                        <span className={`text-2xl font-bold text-${config.colors.success}-700`}>
                          {score.totalRP.toFixed(1)} {config.pointsAbbreviation}
                        </span>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="space-y-6">
                  {config.trials.map(trial => {
                    const result = results[trial.id];
                    const Icon = IconMap[trial.icon] || Users;

                    return (
                      <div key={trial.id} className={`bg-${config.colors.primary}-50 rounded-lg p-6 border-2 border-${config.colors.primary}-300`}>
                        <div className="flex items-start gap-3 mb-4">
                          <Icon className={`w-8 h-8 text-${config.colors.primary}-700 flex-shrink-0 mt-1`} />
                          <div className="flex-1">
                            <h5 className={`text-xl font-bold text-${config.colors.primary}-900`}>{trial.name}</h5>
                            <p className={`text-sm text-${config.colors.primary}-700`}>{trial.description}</p>
                            <p className={`text-sm font-semibold text-${config.colors.success}-700 mt-1`}>
                              Worth: {rp[trial.id]} {config.pointsAbbreviation}
                            </p>
                          </div>
                        </div>

                        {result.contestants.length === 0 ? (
                          <div className="text-gray-500 italic">{config.text.noValidAttempts}</div>
                        ) : (
                          <div className="space-y-3">
                            {result.contestants.map((contestant) => {
                              const isWinner = result.winners.some(w => w.wizardId === contestant.wizardId);
                              
                              return (
                                <div
                                  key={contestant.wizardId}
                                  className={`p-4 rounded ${
                                    isWinner
                                      ? `bg-${config.colors.success}-100 border-2 border-${config.colors.success}-400`
                                      : 'bg-white border-2 border-gray-200'
                                  }`}
                                >
                                  <div className="flex justify-between items-start mb-2">
                                    <div>
                                      <span className={`font-bold text-lg text-${config.colors.primary}-900`}>
                                        {contestant.wizardName}
                                      </span>
                                      {isWinner && (
                                        <span className={`ml-3 px-3 py-1 bg-${config.colors.success}-600 text-white rounded-full text-sm font-bold`}>
                                          {config.text.winner} - {result.rpPerWinner.toFixed(1)} {config.pointsAbbreviation}
                                        </span>
                                      )}
                                    </div>
                                    <span className={`text-2xl font-bold text-${config.colors.primary}-700`}>
                                      {contestant.total}
                                    </span>
                                  </div>

                                  <div className="grid grid-cols-2 gap-2 text-sm">
                                    <div>
                                      <span className="text-gray-600">Utilization:</span>
                                      <span className="ml-2 font-semibold">
                                        {(contestant.utilization * 100).toFixed(1)}%
                                      </span>
                                    </div>
                                    <div>
                                      <span className="text-gray-600">Focus:</span>
                                      <span className="ml-2 font-semibold">
                                        {(contestant.focus * 100).toFixed(1)}%
                                      </span>
                                    </div>
                                  </div>

                                  <div className="mt-2 text-sm">
                                    <span className="text-gray-600">Sources:</span>
                                    <div className="ml-2 mt-1 flex flex-wrap gap-2">
                                      {Object.entries(contestant.sources)
                                        .filter(([domain]) => domain !== 'wilds')
                                        .map(([domain, amount]) => (
                                          <span key={domain} className={`px-2 py-1 bg-${config.colors.primary}-100 rounded text-${config.colors.primary}-900 font-medium`}>
                                            {DOMAIN_NAMES[domain]}: {amount}
                                          </span>
                                        ))}
                                      {contestant.wildPower > 0 && (
                                        <span className="px-2 py-1 bg-amber-100 rounded text-amber-900 font-medium">
                                          ⭐ Wild Magic: {contestant.wildPower}
                                        </span>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ArchmageAscensionApp />);
    </script>
</body>
</html>
